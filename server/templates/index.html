<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Elder Safety Dashboard</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

		<script defer src="{{ url_for('static', filename='app.js') }}"></script>
	</head>

	<body>
		<header class="header">
			<div class="title">
				<h1>ğŸ¥ Elder Care Monitor</h1>
				<p>Real-time MQTT Stream + Historical Analytics</p>
			</div>

			<div class="right">
				<div class="chip">Last Event: <strong id="lastUpdate">--:--:--</strong></div>
				<div class="chip">Status: <span id="systemStatus" class="badge ok">Connecting...</span></div>
			</div>
		</header>

		<!-- Statistics Dashboard -->
		<section class="stats-dashboard">
			<div class="stats-header">
				<h2>24-Hour Statistics</h2>
				<button onclick="refreshStats()" class="refresh-btn">ğŸ”„ Refresh</button>
			</div>
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-icon">ğŸŒ¡ï¸</div>
					<div class="stat-content">
						<div class="stat-label">Avg Temperature</div>
						<div class="stat-value" id="stat-avg-temp">--</div>
						<div class="stat-range">Min: <span id="stat-min-temp">--</span> | Max: <span id="stat-max-temp">--</span></div>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">ğŸ’§</div>
					<div class="stat-content">
						<div class="stat-label">Avg Humidity</div>
						<div class="stat-value" id="stat-avg-hum">--</div>
						<div class="stat-range">Readings: <span id="stat-readings">0</span></div>
					</div>
				</div>
				<div class="stat-card alert-card">
					<div class="stat-icon">ğŸš¨</div>
					<div class="stat-content">
						<div class="stat-label">Emergencies</div>
						<div class="stat-value" id="stat-emergencies">0</div>
						<div class="stat-range">Last 24 hours</div>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">ğŸ’¬</div>
					<div class="stat-content">
						<div class="stat-label">Total Messages</div>
						<div class="stat-value" id="stat-messages">0</div>
						<div class="stat-range">All events</div>
					</div>
				</div>
			</div>
		</section>

		<main class="main">
			<section class="cards">
				<article class="card">
					<div class="label">Active Devices</div>
					<div class="value" id="statDevices">0</div>
				</article>
				<article class="card">
					<div class="label">Current Temperature</div>
					<div class="value"><span id="statAvgTemp">-</span> <span class="unit">Â°C</span></div>
				</article>
				<article class="card">
					<div class="label">Current Humidity</div>
					<div class="value"><span id="statAvgHum">-</span> <span class="unit">%</span></div>
				</article>
			</section>

			<!-- Charts Section -->
			<section class="charts-section">
				<article class="panel chart-panel">
					<div class="panelHeader">
						<h2>Temperature & Humidity Trends</h2>
						<div class="chart-controls">
							<label>Time Range:</label>
							<select id="chartTimeRange" onchange="updateCharts()">
								<option value="1">Last 1 Hour</option>
								<option value="3">Last 3 Hours</option>
								<option value="6" selected>Last 6 Hours</option>
								<option value="12">Last 12 Hours</option>
								<option value="24">Last 24 Hours</option>
							</select>
						</div>
					</div>
					<div class="chart-container">
						<canvas id="envChart"></canvas>
					</div>
				</article>
			</section>

			<!-- Alert Threshold Settings -->
			<section class="threshold-section">
				<article class="panel">
					<div class="panelHeader">
						<h2>âš™ï¸ Alert Threshold Settings</h2>
					</div>
					<div class="threshold-controls">
						<div class="threshold-item">
							<label>High Temperature Alert (Â°C):</label>
							<input type="number" id="tempThreshold" value="30" min="20" max="50" step="0.5">
						</div>
						<div class="threshold-item">
							<label>High Humidity Alert (%):</label>
							<input type="number" id="humThreshold" value="80" min="50" max="100" step="5">
						</div>
						<div class="threshold-status">
							<span id="thresholdAlert"></span>
						</div>
					</div>
				</article>
			</section>

			<section class="grid">
				<article class="panel">
					<div class="panelHeader">
						<h2>Active Units (Real-time)</h2>
					</div>
					<div class="tableWrap">
						<table>
							<thead>
								<tr>
									<th>Device ID</th>
									<th>Type</th>
									<th>Battery</th>
									<th>Last Seen</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody id="telemetryRows"></tbody>
						</table>
					</div>
				</article>

				<article class="panel">
					<div class="panelHeader">
						<h2>Send Message to Bedside</h2>
					</div>
					<div style="padding: 15px; display: flex; flex-direction: column; gap: 10px;">
						<input type="text" id="msgInput" placeholder="Ex: Take your medicine..."
							style="padding: 10px; border: 1px solid #ccc; border-radius: 6px;">

						<div style="display: flex; gap: 10px;">
							<button onclick="sendMsg('green')" style="flex:1; padding: 10px; background: #2b7a56; color: white; border: none; border-radius: 6px; cursor: pointer;">Normal (Green)</button>
							<button onclick="sendMsg('red')" style="flex:1; padding: 10px; background: #d64541; color: white; border: none; border-radius: 6px; cursor: pointer;">Urgent (Red)</button>
						</div>
						<div id="msgStatus" class="small" style="text-align: center; margin-top: 5px; opacity: 0;">Sent!</div>
					</div>
				</article>

				<article class="panel">
					<div class="panelHeader">
						<h2>Live Alert Feed</h2>
					</div>
					<div class="alerts" id="alertsList">
						<div class="small" style="padding:10px">Waiting for events...</div>
					</div>
				</article>
			</section>

			<!-- Event History Section -->
			<section class="history-section">
				<article class="panel history-panel">
					<div class="panelHeader">
						<h2>ğŸ“œ Event History</h2>
						<div class="history-controls">
							<label>Show:</label>
							<select id="eventFilter" onchange="updateHistory()">
								<option value="all">All Events</option>
								<option value="emerg">Emergencies Only</option>
							</select>
							<label>Time Range:</label>
							<select id="historyTimeRange" onchange="updateHistory()">
								<option value="6">Last 6 Hours</option>
								<option value="12">Last 12 Hours</option>
								<option value="24" selected>Last 24 Hours</option>
								<option value="48">Last 48 Hours</option>
								<option value="168">Last Week</option>
							</select>
						</div>
					</div>
					<div class="tableWrap">
						<table class="history-table">
							<thead>
								<tr>
									<th>Time</th>
									<th>Type</th>
									<th>Message</th>
								</tr>
							</thead>
							<tbody id="historyRows">
								<tr><td colspan="3" style="text-align:center; padding: 20px;">Loading history...</td></tr>
							</tbody>
						</table>
					</div>
				</article>
			</section>
		</main>

		<footer class="footer">
			Â© 2026 Elder Care System | MQTT + Flask + WebSockets + PostgreSQL
		</footer>
	</body>
</html>
